# 浅析CPU中断技术

Linux内核对计算机上所有的设备进行管理, 进行管理的方式是内核和设备之间的通信, 通信的方式有两种:
+ 轮询, 内核对设备状态进行周期性的查询
+ 中断, 在设备需要CPU的时候主动发起通信

中断使得硬件得以发出通知给处理器, 中断本质上是一种特殊的电信号, 由硬件设备发向处理器, 处理器接收到中断后, 会马上向操作系统反映此信号的到来, 然后就由操作系统负责处理这些新到来的数据. 硬件设备生成中断的时候并不考虑与处理器的时钟同步, 即中断随时可以产生, 内核随时可能因为新到来的中断而被打断

从物理学的角度看, 中断是一种电信号, 由硬件设备产生, 并直接送入中断控制器(如8259A)的输入引脚上, 然后再由中断控制器向处理器发送相应的信号, 处理器一经检测到该信号, 便中断自己当前正在处理的工作, 转而去处理中断. 此后, 处理器会通知OS已经产生中断, 这样, OS就可以对这个中断进行适当的处理. 

不同的设备对应的中断不同, 而每个中断都通过一个唯一的数字标识, 这些值通常被称为中断请求(IRQ)线, 每个IRQ线都会被关联一个数值, 例如IRQ0是时钟中断, IRQ1是键盘中断, 在PCI总线上的设备而言, 中断是动态分配的

中断可以分为NMI(Non-Maskable Interrupt, 不可屏蔽中断)和INTR(可屏蔽中断), NMI通常用于电源掉电和物理存储器奇偶校验, INTR通过设置中断屏蔽位来进行中断屏蔽, 它主要用于接受外部硬件的中断信号, 这些信号由中断控制器传递给CPU

常见的两种中断控制器:
+ 可编程中断控制器(PIC, Programmable Interrupt Controller) 8259A
+ 高级可编程中断控制器(APIC)

传统的PIC是由两片8259A风格的外部芯片"级联"的方式连接在一起, 每个芯片可处理多达8个不同的IRQ, 因为从PIC的INT输出线连接到主PIC的IRQ2引脚, 所以IRQ线的个数达到15个

## 异常

异常与中断不同, 它在产生时必须考虑与处理器时钟同步. 实际上, 异常也常常称为同步中断, 在处理器执行到由于编程失误而导致的错误指令(如被0除)的时候, 或者是在执行期间出现特殊情况(如缺页, page fault), 必须靠内核来处理时, 处理器就会产生一个异常. 因为许多处理器体系结构处理异常与处理中断的方式类似, 因此内核对他们的处理也很类似

处理中断与处理异常的方式类似, 差异在于中断是由硬件而不是软件引起的

## /proc/interrupts

/proc/interrupts文件存放的是系统中与中断相关的统计信息

```console
# cat /proc/interrupts
         CPU0      CPU1
  0:     1167       0    IO-APIC-edge      timer
  1:      135       0    IO-APIC-edge      i8042
  ...
```
第一列是中断线, 第二列是一个接收中断数目的计数器, 系统中每个处理器都存在这样的列, 第四列是处理这个中断的中断控制器, 在具有I/O APIC的系统上, 大多数中断会列出IO-APIC-level或IO-APIC-dege, 作为自己的中断控制器, 最后一列是与这个中断相关的设备名字, 这个名字是通过参数devname提供给函数`request_irq()`的, 如果中断是共享的, 则这条中断线上注册的所有设备都会列出来 

## 相关名词

+ IRQ
    + Interrupt Request, 中断请求, 从硬件层发出
    + 作用: 执行硬件中断的请求
+ SMP
    + Symmetrical Multi-Processing
    + 对称多处理系统, 指在一个计算机上汇集了一组CPU, 各CPU之间共享内存子系统以及总线结构, 或者说两个或多个同样的处理器通过一块共享内存彼此连接
    + 作用: 适用于多处理器计算机
+ APIC
    + Advanced Programmable Interrupt Controllers, 高级可编程中断控制器
+ 松耦合多处理架构
    + 这些系统是利用多个高速互连的单一系统构造的
+ CMP
    + 芯片多级处理, 是一种紧密耦合多处理器, 可以将它看作将松耦合架构缩小至芯片级, 即在一个集成电路中, 多个芯片、共享内存以及互联形成了一个紧密集成的多处理核心

