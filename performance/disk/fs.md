# fs, file system, 文件系统

计算机的文件系统是一种存储和组织计算机数据的方法, 使用文件和树形目录的抽象概念代替了硬盘和光盘等物理设备使用数据块的概念

严格地说, 文件系统是一套实现了数据的存储、分级组织、访问和获取等操作的抽象数据类型

尽管内核是linux的核心, 但文件却是用户与操作系统交互所采用的主要工具。这对linux来说尤其如此, 这是因为在UNIX传统中, 它使用文件I/O机制管理硬件设备和数据文件


## rootfs, 根文件系统

rootfs, 是内核启动时所挂载的第一个文件系统, 内核代码的映像文件保存在根文件系统中, 系统引导启动程序会在根文件系统挂载之后从中把一些初始化脚本和服务加载到内存中去运行

```
1. init进程的应用程序必须运行在根文件系统上
2. 根文件系统提供了根目录 "/"
3. linux挂载分区时所依赖的信息存放于根文件系统/etc/fstab这个文件中
4. shell命令程序必须运行在根文件系统上, 如ls, cd等命令
```

rootfs是基于内存的文件系统, 所有操作都在内存中完成；也没有实际的存储设备, 所以不需要设备驱动程序的参与。基于以上原因, linux在启动阶段使用rootfs文件系统, 当磁盘驱动程序和磁盘文件系统成功加载后, linux系统会将系统根目录从rootfs切换到磁盘文件系统

正常来说, 根文件系统至少包括以下目录: 
```
1. /etc/, 存储重要的配置文件
2. /bin/, 存储常用且开机时必须用到的执行文件
3. /sbin/, 存储着开机过程中所需的系统执行文件
4. /lib/, 存储/bin/及/sbin/的执行文件所需的链接库, 以及linux的内核模块
5. /dev/, 存储设备文件
```

## Overlayfs

Overlayfs是一种堆叠文件系统, 它依赖并建立在其它的文件系统之上(如ext4fs, xfs等), 并不直接参与磁盘空间结构的划分, 仅仅将原来底层文件系统中不同的目录进行"合并", 然后向用户呈现

```
Merge dir    Show Dir
Upper dir    Private Dir
Lower dir    Share Dir
```

merge dir目录为挂载点, 当文件系统挂载后, 在merge目录下将会同时看到来自各lower和upper目录下的内容

upper dir和各lower dir存在层次关系, 首先当upper dir和lower dir两个目录存在同名文件时, lower dir的文件将会被隐藏, 各个lower dir也存在相同的层次关系, 较上层屏蔽较下层的同名文件

各层目录中的upper dir是可读写的目录, 当用户通过merge dir向其中一个来自upper dir的文件写入数据时, 那数据将直接写入upper dir下原来的文件中, 删除文件也是同理; 而各lower dir则是只读的, 在overlayfs挂载后无论如何操作merge目录中对应来自lower dir的文件或目录, lower dir中的内容均不会发生任何改变; 当用户想往lower层的文件添加或修改内容时, overlayfs会先拷贝一份lower dir目录中的文件副本到upper dir中, 后续的写入和修改操作将会在upper dir下的copy-up的副本文件中进行, lower dir原文件被隐藏

```
1. 上下层同名目录合并
2. 上下层同名文件覆盖
3. lower dir文件写时拷贝
```
